<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>استمارة اسبيل الذكية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #ffffff; color: #000; }
        
        select.rubric-select {
            background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
            background-position: left 0.5rem top 1rem;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            white-space: normal;
            height: auto;
            min-height: 3rem;
        }

        .wheel-container { position: relative; width: 150px; height: 150px; margin: 0 auto; }
        .wheel-svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        .legend-item { display: flex; align-items: center; font-size: 0.75rem; margin-bottom: 0.25rem; }
        .legend-color { width: 10px; height: 10px; border-radius: 50%; margin-left: 0.5rem; }
        .header-container { border-bottom: 3px double #000; padding-bottom: 10px; margin-bottom: 20px; }
        
        .signature-pad-wrapper {
            position: relative;
            background-color: #f9fafb;
            border: 2px dashed #cbd5e1;
            border-radius: 0.5rem;
            height: 140px;
            width: 100%;
            touch-action: none; 
        }
        canvas.signature-pad { display: block; width: 100%; height: 100%; }

        #saveIndicator {
            position: fixed; bottom: 20px; left: 20px; background-color: #10b981; color: white;
            padding: 8px 12px; border-radius: 20px; font-size: 0.8rem; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            opacity: 0; transition: opacity 0.5s; z-index: 9999; pointer-events: none;
        }

        /* --- إعدادات الطباعة الدقيقة --- */
        @media print {
            .no-print { display: none !important; }
            #saveIndicator { display: none !important; }
            
            body { 
                background-color: white; 
                margin-top: 0; 
                font-size: 14pt !important; 
            }

            /* الترويسة الثابتة */
            .header-fixed {
                position: fixed; top: 0; left: 0; right: 0; height: auto;
                background: white; z-index: 1000; border-bottom: 2px solid black; 
                padding: 5px 40px !important;
            }
            .header-fixed p, .header-fixed span { font-size: 13pt !important; line-height: 1.3 !important; font-weight: bold !important; }
            .header-fixed h1 { font-size: 18pt !important; font-weight: bold !important; margin-bottom: 0 !important; }
            .header-fixed .sub-title { font-size: 14pt !important; font-weight: bold !important; margin-top: 0 !important; }
            .header-fixed img { height: 80px !important; width: auto !important; margin-bottom: 0 !important; }

            /* هوامش المحتوى */
            main { margin-top: 200px !important; } 

            /* الجداول */
            table { page-break-inside: auto; border: 1px solid #000; width: 100%; border-collapse: collapse; }
            tr { page-break-inside: avoid; page-break-after: auto; }
            thead { display: table-header-group; }
            tfoot { display: table-footer-group; }
            
            th { border: 1px solid #000; padding: 4px !important; text-align: center; font-size: 14pt !important; background-color: #f3f4f6 !important; font-weight: bold !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            td { border: 1px solid #000; padding: 4px !important; text-align: center; font-size: 14pt !important; }
            
            .domain-title-print { font-size: 14pt !important; font-weight: bold !important; }
            .signature-label { font-size: 14pt !important; font-weight: bold !important; color: #000 !important; }

            .shadow-lg, .shadow-md, .shadow { box-shadow: none !important; }
            .border-t-4 { border-top: 1px solid #000 !important; }
            .col-rubric { display: none !important; }
            .print-border { border: 1px solid #000 !important; }
            #statsTable th { background-color: #e5e7eb !important; font-weight: bold; }
            .overflow-y-auto { overflow: visible !important; height: auto !important; }
            
            .signature-pad-wrapper { border: none !important; background-color: transparent !important; }
            .signature-clear-btn { display: none !important; }
            .signature-input { border: none !important; background: transparent !important; font-size: 14pt !important; font-weight: bold; margin-bottom: 0 !important; }
            
            select { appearance: none; border: none; background: transparent; padding: 0; font-size: 14pt !important; font-weight: normal; color: black; }

            .teacher-info-box { padding: 5px !important; margin-bottom: 5px !important; margin-top: 10px !important; }
            .teacher-info-label { font-size: 13pt !important; margin-bottom: 0 !important; }
            .teacher-info-input { padding: 0 !important; font-size: 13pt !important; height: auto !important; }

            /* تنسيق أفقي لبيانات المعلم */
            .grid-print-horizontal {
                display: flex !important;
                justify-content: space-between;
                gap: 10px;
            }
            .grid-print-horizontal > div {
                flex: 1;
            }

            /* --- إصلاح التوقيعات في الطباعة العمودية والأفقية --- */
            .signatures-grid-print {
                display: flex !important; /* استخدام فليكس بدلاً من جريد لتجنب الانهيار */
                justify-content: space-between !important;
                align-items: flex-start !important;
                gap: 10px !important;
                page-break-inside: avoid !important;
            }
            
            .signature-block {
                width: 32% !important; /* ضمان العرض */
                display: inline-block !important;
            }
            
            /* ضمان ارتفاع الرسمة */
            .signature-pad-wrapper {
                min-height: 100px !important;
                height: 100px !important; 
                display: block !important;
            }
            
            canvas.signature-pad {
                width: 100% !important;
                height: 100% !important;
                display: block !important;
            }
        }
    </style>
</head>
<body class="text-slate-800 p-4 md:p-8">

    <!-- ✅✅✅ كود الحماية المضاف ✅✅✅ -->
    <div id="sano-gate" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #f3f4f6; z-index: 9999999; display: flex; flex-direction: column; justify-content: center; align-items: center; font-family: 'Tajawal', sans-serif;">
        <div style="background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; max-width: 400px; width: 90%;">
            <h2 style="color: #1f2937; margin-bottom: 20px; font-weight: 800;">نظام حماية الاستمارة</h2>
            <div style="margin-bottom: 20px;">
                <input type="password" id="sano-input" placeholder="أدخل كود المرور" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; text-align: center; font-size: 16px; outline: none; transition: border-color 0.3s;">
            </div>
            <button onclick="authSano()" style="background-color: #ca8a04; color: white; border: none; padding: 12px 30px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: background 0.3s; width: 100%;">دخول</button>
            <p id="sano-msg" style="color: #ef4444; margin-top: 15px; font-size: 14px; display: none; font-weight: bold;">الكود غير صحيح</p>
        </div>
    </div>

    <!-- Save Indicator -->
    <div id="saveIndicator"><i class="fa-solid fa-check"></i> تم الحفظ تلقائياً</div>

    <!-- Print Header (ثابتة في كل صفحة طباعة) -->
    <div class="hidden print:block header-fixed">
        <div class="flex justify-between items-start w-full mb-1">
            <div class="text-right font-bold">
                <p>الجمهورية اليمنية</p>
                <p>محافظة تعز</p>
                <p>مكتب التربية والتعليم</p>
                <p>مدارس اسبيل الأهلية (المظفر)</p>
            </div>
            <div class="text-center flex flex-col items-center">
                <p class="mb-1 font-bold text-lg">بسم الله الرحمن الرحيم</p>
                <!-- صورة الشعار -->
                <img src="images.jpeg" alt="[شعار المدرسة]" class="h-20 w-auto object-contain mb-1" onerror="this.style.display='none';">
            </div>
            <div class="text-left font-bold">
                <p>نموذج آلي</p>
                <p>التاريخ: <span class="printDatePlaceholder"></span></p>
                <p>المرفقات: ....................</p>
            </div>
        </div>
        <div class="text-center mt-1 border-t-2 border-black pt-1">
            <h1 style="font-weight: bold;">استمارة اسبيل الذكية</h1>
            <p class="font-bold sub-title">(للتقييم الشامل لأداء المعلم)</p>
        </div>
    </div>

    <!-- Screen Header (تظهر على الشاشة فقط) -->
    <header class="header-container w-full max-w-6xl mx-auto no-print">
        <div class="flex justify-between items-start w-full mb-4">
            <div class="text-right font-bold text-sm leading-7">
                <p>الجمهورية اليمنية</p>
                <p>محافظة تعز</p>
                <p>مكتب التربية والتعليم</p>
                <p>مدارس اسبيل الأهلية (المظفر)</p>
            </div>
            <div class="text-center flex flex-col items-center">
                <p class="mb-2 font-bold text-lg">بسم الله الرحمن الرحيم</p>
                <img src="images.jpeg" alt="شعار المدرسة" class="h-24 w-auto object-contain mb-2">
            </div>
            <div class="text-left font-bold text-sm leading-7">
                <p>نموذج آلي</p>
                <p>التاريخ: <span id="headerDate"></span></p>
                <p>المرفقات: ....................</p>
            </div>
        </div>
        <div class="text-center mt-4">
            <h1 style="font-size: 18pt; font-weight: bold; color: #000;">استمارة اسبيل الذكية</h1>
            <p class="font-bold text-sm mt-1">(للتقييم الشامل لأداء المعلم)</p>
        </div>
    </header>

    <main class="container mx-auto max-w-6xl">

        <!-- Teacher Info -->
        <section class="teacher-info-box bg-white border border-gray-300 rounded-lg p-4 mb-6 shadow-sm print:shadow-none print:border-black">
            <h2 class="text-base font-bold mb-3 flex items-center text-slate-800 border-b pb-2 print:text-black domain-title-print">
                <i class="fa-solid fa-address-card ml-2 text-yellow-600 no-print"></i> بيانات المعلم
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm grid-print-horizontal">
                <div>
                    <label class="teacher-info-label block font-bold text-slate-600 mb-1 print:text-black">اسم المعلم</label>
                    <input type="text" id="teacherName" oninput="autoSave()" class="teacher-info-input w-full p-1.5 bg-slate-50 border border-slate-300 rounded focus:border-yellow-500 outline-none transition print:bg-transparent print:border-none print:border-b print:border-black" placeholder="الاسم الثلاثي">
                </div>
                <div>
                    <label class="teacher-info-label block font-bold text-slate-600 mb-1 print:text-black">المادة / الصف</label>
                    <input type="text" id="subjectClass" oninput="autoSave()" class="teacher-info-input w-full p-1.5 bg-slate-50 border border-slate-300 rounded focus:border-yellow-500 outline-none transition print:bg-transparent print:border-none print:border-b print:border-black">
                </div>
                <div>
                    <label class="teacher-info-label block font-bold text-slate-600 mb-1 print:text-black">نوع الزيارة</label>
                    <select id="visitType" onchange="autoSave()" class="teacher-info-input w-full p-1.5 bg-slate-50 border border-slate-300 rounded outline-none cursor-pointer print:hidden">
                        <option>زيارة إشرافية تشخيصية</option>
                        <option>زيارة متابعة فنية</option>
                        <option>زيارة تقويم ختامي</option>
                    </select>
                    <div id="visitTypePrint" class="hidden print:block border-b border-black font-bold text-[13pt]"></div>
                </div>
            </div>
        </section>

        <!-- Compact Timer & Interaction Section (Screen Only) -->
        <section class="bg-white rounded-xl shadow-md p-4 mb-6 border-t-4 border-blue-600 no-print">
            <h2 class="text-base font-bold mb-3 flex items-center text-blue-800 border-b pb-2">
                <i class="fa-solid fa-stopwatch ml-2"></i> مؤشر التفاعل اللفظي
            </h2>
            <div class="flex flex-wrap justify-center gap-4 items-center">
                <div class="flex items-center gap-2 p-2 bg-blue-50 rounded border border-blue-100">
                    <div class="text-center">
                        <div class="text-xs font-bold text-blue-900">زمن المعلم</div>
                        <div id="teacherTimerDisplay" class="text-lg font-mono font-bold text-blue-600">00:00</div>
                    </div>
                    <button id="btnTeacher" onclick="toggleTimer('teacher')" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs font-bold transition">
                        <i class="fa-solid fa-microphone"></i> تحدث
                    </button>
                </div>
                <div class="relative w-16 h-16">
                    <svg class="w-full h-full" viewBox="0 0 36 36">
                        <path class="text-orange-100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="4" />
                        <path id="interactionCircle" class="text-blue-500 transition-all duration-500 ease-out" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="4" />
                    </svg>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <button onclick="pauseTimer()" class="text-gray-500 hover:text-gray-700 text-xs">
                            <i class="fa-solid fa-pause"></i>
                        </button>
                    </div>
                </div>
                <div class="flex items-center gap-2 p-2 bg-orange-50 rounded border border-orange-100">
                    <button id="btnStudent" onclick="toggleTimer('student')" class="px-3 py-1 bg-orange-500 hover:bg-orange-600 text-white rounded text-xs font-bold transition">
                        <i class="fa-solid fa-users"></i> تحدث
                    </button>
                    <div class="text-center">
                        <div class="text-xs font-bold text-orange-900">زمن الطلاب</div>
                        <div id="studentTimerDisplay" class="text-lg font-mono font-bold text-orange-600">00:00</div>
                    </div>
                </div>
                <div class="text-xs font-bold space-x-2 space-x-reverse">
                    <span id="teacherPercent" class="text-blue-600">0% م</span>
                    <span class="text-gray-300">|</span>
                    <span id="studentPercent" class="text-orange-500">0% ط</span>
                </div>
            </div>
        </section>

        <!-- Wheels Section (Strategies, Aids, Activities) - Screen Only -->
        <section class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 no-print">
            <div class="bg-white rounded-xl shadow-md p-4 border-t-4 border-purple-500 flex flex-col items-center text-center">
                <h2 class="text-sm font-bold mb-2 text-purple-800 w-full text-right border-b pb-1">
                    <i class="fa-solid fa-chess ml-1"></i> الاستراتيجيات
                </h2>
                <div class="w-full mb-2">
                    <select id="strategiesSelect" onchange="addToWheel('strategies')" class="w-full p-1.5 border border-gray-300 rounded text-xs">
                        <option value="">+ أضف استراتيجية...</option>
                    </select>
                </div>
                <div class="flex w-full items-start gap-2 h-32">
                    <div class="wheel-container h-32 w-32">
                        <svg id="strategiesWheel" class="wheel-svg" viewBox="0 0 32 32">
                            <circle r="16" cx="16" cy="16" fill="#f3f4f6" />
                        </svg>
                    </div>
                    <div id="strategiesLegend" class="flex-1 overflow-y-auto h-32 pr-1 text-left"></div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-md p-4 border-t-4 border-pink-500 flex flex-col items-center text-center">
                <h2 class="text-sm font-bold mb-2 text-pink-800 w-full text-right border-b pb-1">
                    <i class="fa-solid fa-laptop-file ml-1"></i> الوسائل
                </h2>
                <div class="w-full mb-2">
                    <select id="aidsSelect" onchange="addToWheel('aids')" class="w-full p-1.5 border border-gray-300 rounded text-xs">
                        <option value="">+ أضف وسيلة...</option>
                    </select>
                </div>
                <div class="flex w-full items-start gap-2 h-32">
                    <div class="wheel-container h-32 w-32">
                        <svg id="aidsWheel" class="wheel-svg" viewBox="0 0 32 32">
                            <circle r="16" cx="16" cy="16" fill="#f3f4f6" />
                        </svg>
                    </div>
                    <div id="aidsLegend" class="flex-1 overflow-y-auto h-32 pr-1 text-left"></div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-md p-4 border-t-4 border-green-500 flex flex-col items-center text-center">
                <h2 class="text-sm font-bold mb-2 text-green-800 w-full text-right border-b pb-1">
                    <i class="fa-solid fa-people-group ml-1"></i> الأنشطة الصفية
                </h2>
                <div class="w-full mb-2">
                    <select id="activitiesSelect" onchange="addToWheel('activities')" class="w-full p-1.5 border border-gray-300 rounded text-xs">
                        <option value="">+ أضف نشاطاً...</option>
                    </select>
                </div>
                <div class="flex w-full items-start gap-2 h-32">
                    <div class="wheel-container h-32 w-32">
                        <svg id="activitiesWheel" class="wheel-svg" viewBox="0 0 32 32">
                            <circle r="16" cx="16" cy="16" fill="#f3f4f6" />
                        </svg>
                    </div>
                    <div id="activitiesLegend" class="flex-1 overflow-y-auto h-32 pr-1 text-left"></div>
                </div>
            </div>
        </section>

        <!-- Evaluation Table -->
        <div id="evaluationTableContainer"></div>

        <!-- Grand Total Section -->
        <div class="bg-slate-800 text-white p-4 rounded-xl shadow-lg mt-6 flex flex-col md:flex-row justify-between items-center print:bg-white print:text-black print:border print:border-black">
            <div class="text-center md:text-right mb-2 md:mb-0">
                <h3 class="text-xl font-bold domain-title-print">النتيجة النهائية</h3>
            </div>
            <div class="flex items-center gap-6">
                <div class="text-center border-l border-slate-600 pl-6 print:border-black">
                    <span class="block text-xs text-slate-400 print:text-black font-bold" style="font-size: 14pt !important;">المجموع</span>
                    <span id="grandTotalPoints" class="text-2xl font-bold text-yellow-400 print:text-black" style="font-size: 14pt !important;">0</span>
                    <span class="text-xs text-gray-500 print:text-black font-bold" style="font-size: 14pt !important;">/ 100</span> 
                </div>
                <div class="text-center border-l border-slate-600 pl-6 print:border-black">
                    <span class="block text-xs text-slate-400 print:text-black font-bold" style="font-size: 14pt !important;">النسبة</span>
                    <span id="grandTotalPercent" class="text-2xl font-bold text-white print:text-black" style="font-size: 14pt !important;">0%</span>
                </div>
                <div class="text-center">
                    <span class="block text-xs text-slate-400 print:text-black font-bold" style="font-size: 14pt !important;">التقدير</span>
                    <span id="grandTotalRating" class="px-4 py-1 rounded-lg bg-slate-600 font-bold print:bg-white print:border print:border-black" style="font-size: 14pt !important;">--</span>
                </div>
            </div>
        </div>

        <!-- Action Buttons (Screen Only) -->
        <section class="no-print flex flex-wrap gap-3 justify-center mt-8 mb-12">
            <button onclick="toggleReport('statisticalReportBox', generateStatisticalReport)" class="group bg-purple-700 hover:bg-purple-800 text-white font-bold py-2 px-5 rounded-lg shadow-md transition flex items-center">
                <i class="fa-solid fa-table-list ml-2"></i> التقرير الإحصائي (إظهار/إخفاء)
            </button>
            <button onclick="toggleReport('aiReportBox', generateAIReport)" class="group bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition flex items-center">
                <i class="fa-solid fa-robot ml-2"></i> التقرير التشخيصي (إظهار/إخفاء)
            </button>
            <button onclick="toggleReport('remedialPlanBox', generateRemedialPlan)" class="group bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition flex items-center">
                <i class="fa-solid fa-road ml-2"></i> الخطة العلاجية (إظهار/إخفاء)
            </button>
            <div class="w-full md:w-auto h-8 md:h-auto border-r border-gray-300 mx-2"></div>
            <button onclick="resetData()" class="group bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition flex items-center">
                <i class="fa-solid fa-trash-can ml-2"></i> تصفير
            </button>
            <button onclick="shareReport()" class="group bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition flex items-center">
                <i class="fa-solid fa-share-nodes ml-2"></i> مشاركة
            </button>
            <button onclick="checkAndPrint()" class="group bg-yellow-500 hover:bg-yellow-600 text-slate-900 font-bold py-2 px-5 rounded-lg shadow-md transition flex items-center">
                <i class="fa-solid fa-print ml-2"></i> طباعة الاستمارة
            </button>
        </section>

        <!-- Reports Container -->
        <section id="reportsSection" class="hidden mt-6 space-y-8 print:block">
            <div class="print:page-break"></div>
            <!-- Reports -->
            <div id="statisticalReportBox" class="hidden print:hidden mb-8">
                <h3 class="text-lg font-bold text-purple-900 mb-2 border-b-2 border-purple-200 pb-1 print:text-black print:border-black domain-title-print"><i class="fa-solid fa-chart-simple ml-2"></i> التقرير الإحصائي الشامل</h3>
                <div class="overflow-x-auto"><table id="statsTable" class="w-full text-right border border-gray-300 text-sm print:border-black"></table></div>
            </div>
            <div id="aiReportBox" class="bg-white rounded-xl shadow-lg border-t-4 border-blue-500 hidden print:hidden mb-8 print:shadow-none print:border-2 print:border-black">
                <div class="p-3 bg-blue-50 border-b border-blue-100 print:bg-gray-200 print:border-black"><h3 class="font-bold text-blue-900 flex items-center print:text-black domain-title-print"><i class="fa-solid fa-magnifying-glass-chart ml-2"></i> التقرير التشخيصي</h3></div>
                <div class="p-4 text-slate-700 leading-relaxed text-sm" id="aiReportContent" style="font-size: 14pt !important;"></div>
            </div>
            <div id="remedialPlanBox" class="bg-white rounded-xl shadow-lg border-t-4 border-emerald-500 hidden print:hidden mb-8 print:shadow-none print:border-2 print:border-black">
                <div class="p-3 bg-emerald-50 border-b border-emerald-100 print:bg-gray-200 print:border-black"><h3 class="font-bold text-emerald-900 flex items-center print:text-black domain-title-print"><i class="fa-solid fa-clipboard-list ml-2"></i> الخطة العلاجية</h3></div>
                <div class="p-4" id="remedialPlanContent" style="font-size: 14pt !important;"></div>
            </div>
        </section>

        <!-- Digital Signatures Section -->
        <section class="mt-8 mb-12 print:mt-4 print:mb-0 page-break-inside-avoid">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 signatures-grid-print">
                <!-- Teacher -->
                <div class="signature-block">
                    <label class="signature-label block font-bold text-sm mb-2 text-slate-700 print:text-black">توقيع المعلم بالعلم</label>
                    <input type="text" id="sigNameTeacher" oninput="autoSave()" placeholder="الاسم" class="signature-input w-full mb-2 p-1 border-b border-gray-300 focus:border-yellow-500 outline-none text-sm print:border-none print:mb-0">
                    <div class="signature-pad-wrapper">
                        <canvas id="sig-teacher" class="signature-pad"></canvas>
                        <button onclick="clearSig('sig-teacher')" class="signature-clear-btn absolute bottom-1 left-1 text-xs bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded text-gray-600 no-print">مسح</button>
                    </div>
                </div>
                <!-- Supervisor -->
                <div class="signature-block">
                    <label class="signature-label block font-bold text-sm mb-2 text-slate-700 print:text-black">المشرف التربوي</label>
                    <input type="text" id="sigNameSupervisor" oninput="autoSave()" placeholder="الاسم" class="signature-input w-full mb-2 p-1 border-b border-gray-300 focus:border-yellow-500 outline-none text-sm print:border-none print:mb-0">
                    <div class="signature-pad-wrapper">
                        <canvas id="sig-supervisor" class="signature-pad"></canvas>
                        <button onclick="clearSig('sig-supervisor')" class="signature-clear-btn absolute bottom-1 left-1 text-xs bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded text-gray-600 no-print">مسح</button>
                    </div>
                </div>
                <!-- Admin -->
                <div class="signature-block">
                    <label class="signature-label block font-bold text-sm mb-2 text-slate-700 print:text-black">إدارة المدرسة</label>
                    <input type="text" id="sigNameAdmin" oninput="autoSave()" placeholder="الاسم" class="signature-input w-full mb-2 p-1 border-b border-gray-300 focus:border-yellow-500 outline-none text-sm print:border-none print:mb-0">
                    <div class="signature-pad-wrapper">
                        <canvas id="sig-admin" class="signature-pad"></canvas>
                        <button onclick="clearSig('sig-admin')" class="signature-clear-btn absolute bottom-1 left-1 text-xs bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded text-gray-600 no-print">مسح</button>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <script>
        // ✅✅✅ كود حماية الاستمارة ✅✅✅
        // تجميد الصفحة ومنع التمرير حتى يتم فك القفل
        document.body.style.overflow = 'hidden';

        function authSano() {
            const input = document.getElementById('sano-input');
            const gate = document.getElementById('sano-gate');
            const msg = document.getElementById('sano-msg');

            if (input.value === 'sano') {
                // تأثير حركي بسيط للاختفاء
                gate.style.opacity = '0';
                gate.style.transition = 'opacity 0.5s ease';
                
                setTimeout(() => {
                    gate.remove(); // إزالة طبقة الحماية نهائياً من الـ DOM
                    document.body.style.overflow = 'auto'; // إعادة تفعيل التمرير
                }, 500);
            } else {
                msg.style.display = 'block';
                input.style.borderColor = '#ef4444';
            }
        }
        
        // دعم زر Enter
        document.getElementById('sano-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                authSano();
            }
        });

        // Set Gregorian Date
        const dateOptions = { year: 'numeric', month: 'numeric', day: 'numeric' };
        const dateStr = new Date().toLocaleDateString('en-GB', dateOptions); 
        document.getElementById('headerDate').innerText = dateStr;
        const printPlaceholders = document.querySelectorAll('.printDatePlaceholder');
        printPlaceholders.forEach(el => el.innerText = dateStr);

        const domains = [
            {
                title: "المجال الأول: التخطيط والإعداد",
                criteria: [
                    { id: "p1", name: "وضوح الأهداف", options: [{ val: 5, text: "أهداف ذكية (SMART)، متنوعة المستويات (معرفي/مهاري/وجداني)، ومعلنة للطلاب." }, { val: 4, text: "أهداف واضحة ومحددة وقابلة للقياس، تغطي معظم جوانب الدرس." }, { val: 3, text: "أهداف مكتوبة ومقبولة، لكنها تركز على المستويات الدنيا (التذكر والفهم)." }, { val: 2, text: "أهداف عامة غير محددة بزمن أو معيار دقيق (مثلاً: أن يفهم الطالب الدرس)." }, { val: 1, text: "لا توجد أهداف مكتوبة، أو الأهداف لا علاقة لها بمحتوى الدرس." }], advice: "صياغة الأهداف بشكل سلوكي إجرائي وربطها بأنشطة الدرس.", leverage: "تدريب الزملاء على صياغة الأهداف الذكية." },
                    { id: "p2", name: "ملاءمة الخطة للمحتوى", options: [{ val: 5, text: "خطة شاملة ومبتكرة، تربط المحتوى بالواقع، وتوزع الزمن بدقة متناهية." }, { val: 4, text: "خطة مكتملة العناصر وتغطي المحتوى بشكل جيد ومتسلسل." }, { val: 3, text: "خطة تقليدية تغطي الكتاب المدرسي دون إضافات أو إثراء." }, { val: 2, text: "يوجد خلل في تسلسل الأفكار أو عدم توافق بين الخطة والزمن المتاح." }, { val: 1, text: "الخطة عشوائية أو منقولة ولا تعكس محتوى الدرس الفعلي." }], advice: "تحليل المحتوى وتقسيمه زمنياً قبل البدء في التخطيط.", leverage: "بناء خطط نموذجية للوحدات الدراسية." },
                    { id: "p3", name: "مراعاة الفروق الفردية", options: [{ val: 5, text: "تخطيط دقيق لأنشطة متمايزة (إثرائية وعلاجية) تلبي احتياجات جميع الفئات." }, { val: 4, text: "وجود نشاط إضافي واضح للمتفوقين أو المتعثرين ضمن الخطة." }, { val: 3, text: "إشارة نظرية للفروق الفردية في الخطة دون إجراءات تطبيقية واضحة." }, { val: 2, text: "الخطة موحدة للجميع ولا تراعي تباين المستويات." }, { val: 1, text: "تجاهل تام للفروق الفردية واعتماد التلقين الموحد." }], advice: "تصميم أنشطة متعددة المستويات لنفس الهدف.", leverage: "تطبيق استراتيجيات التعليم المتمايز." }
                ]
            },
            {
                title: "المجال الثاني: تنفيذ الدرس",
                criteria: [
                    { id: "e1", name: "التمهيد للدرس", options: [{ val: 5, text: "تمهيد إبداعي وشائق يربط الدرس بالواقع ويثير دافعية الطلاب للتعلم." }, { val: 4, text: "تمهيد جيد يربط الدرس الحالي بالدرس السابق بوضوح." }, { val: 3, text: "تمهيد تقليدي (مراجعة الواجب أو سؤال مباشر)." }, { val: 2, text: "تمهيد طويل جداً وممل، أو قصير جداً غير مفيد." }, { val: 1, text: "دخول مفاجئ في الدرس دون أي مقدمات." }], advice: "التنويع في أساليب التمهيد (قصة، فيديو، مشكلة).", leverage: "ابتكار مداخل شيقة للدروس." },
                    { id: "e2", name: "استراتيجيات التعليم", options: [{ val: 5, text: "تطبيق استراتيجيات تعلم نشط ببراعة تجعل الطالب محور العملية التعليمية." }, { val: 4, text: "تطبيق استراتيجيات متنوعة تشجع على المشاركة." }, { val: 3, text: "الاعتماد على الحوار والمناقشة مع الشرح (نصف نشط)." }, { val: 2, text: "غلبة أسلوب المحاضرة والتلقين مع تفاعل محدود." }, { val: 1, text: "اعتماد القراءة السردية أو الإملاء فقط." }], advice: "تقليل زمن تحدث المعلم وزيادة زمن نشاط الطالب.", leverage: "نقل خبرات التعلم النشط للزملاء." },
                    { id: "e3", name: "توظيف الوسائل التعليمية", options: [{ val: 5, text: "توظيف مثالي للتقنية والوسائل المحسوسة لتبسيط المفاهيم المجردة." }, { val: 4, text: "استخدام وسائل تعليمية مناسبة وواضحة تخدم الهدف." }, { val: 3, text: "استخدام محدود للوسائل (السبورة والكتاب فقط)." }, { val: 2, text: "الوسائل موجودة لكن لم تستخدم بفاعلية أو في غير وقتها." }, { val: 1, text: "عدم استخدام أي وسيلة توضيحية رغم الحاجة إليها." }], advice: "تجهيز الوسائل مسبقاً والتأكد من ملاءمتها.", leverage: "تصميم وإنتاج وسائل تعليمية مبتكرة." },
                    { id: "e4", name: "تنوع الأنشطة", options: [{ val: 5, text: "تنوع ثري بين الأنشطة (فردي، ثنائي، جماعي، حركي) يكسر الملل." }, { val: 4, text: "وجود تنوع جيد في الأنشطة الصفية." }, { val: 3, text: "الاعتماد على نمط واحد من الأنشطة (غالباً فردي)." }, { val: 2, text: "قلة الأنشطة وسيادة الجمود على الحصة." }, { val: 1, text: "غياب الأنشطة تماماً." }], advice: "إدراج نشاط جماعي واحد على الأقل في كل حصة.", leverage: "بناء بنك أنشطة تفاعلية." },
                    { id: "e5", name: "إدارة الوقت", options: [{ val: 5, text: "إدارة احترافية للوقت، توازن مثالي بين مراحل الدرس، وتحقيق الأهداف في الزمن المحدد." }, { val: 4, text: "إدارة جيدة للوقت، مع زيادة أو نقص طفيف لا يخل بالدرس." }, { val: 3, text: "توزيع الوقت مقبول، لكن قد يطغى جزء على آخر." }, { val: 2, text: "سوء إدارة الوقت (التمهيد طويل جداً أو الغلق مبتور)." }, { val: 1, text: "فوضى زمنية (انتهاء الحصة ولم يشرح، أو انتهاء الدرس مبكراً جداً)." }], advice: "استخدام مؤقت زمني لكل فقرة في الدرس.", leverage: "تقديم نموذج في إدارة وقت الحصة." }
                ]
            },
            {
                title: "المجال الثالث: إدارة البيئة التعليمية (التفاعل الصفي)",
                criteria: [
                    { id: "i2", name: "تحفيز التفكير الناقد", options: [{ val: 5, text: "تشجيع الطلاب باستمرار على التحليل، التبرير، وإبداء الرأي وحل المشكلات." }, { val: 4, text: "طرح مواقف تتطلب إعمال العقل وليس مجرد الحفظ." }, { val: 3, text: "محاولات بسيطة لتحفيز التفكير، لكن الغالب هو التلقين." }, { val: 2, text: "التركيز فقط على الحفظ والتسميع." }, { val: 1, text: "قمع محاولات التفكير أو الاستفسار الخارج عن النص." }], advice: "استخدام استراتيجيات (ماذا لو؟) و (قارن بين).", leverage: "رعاية الطلاب الموهوبين." },
                    { id: "i3", name: "التوزيع العادل للمشاركات", options: [{ val: 5, text: "مشاركة شاملة لجميع الطلاب (بمن فيهم الخجولين) باستخدام استراتيجيات عشوائية." }, { val: 4, text: "إشراك معظم الطلاب في الحصة وتوزيع جيد للانتباه." }, { val: 3, text: "التركيز على فئة معينة (المتفوقين أو الصفوف الأمامية)." }, { val: 2, text: "تجاهل مشاركات بعض الطلاب أو الاكتفاء بمن يرفع يده." }, { val: 1, text: "احتكار المشاركة لطالب أو اثنين فقط." }], advice: "استخدام أعواد المثلجات لضمان العدالة.", leverage: "خلق بيئة صفية تشاركية." },
                    { id: "i4", name: "التعزيز والتغذية الراجعة", options: [{ val: 5, text: "تعزيز متنوع وفوري، وتغذية راجعة وصفية توضح للطالب نقاط القوة والتحسين." }, { val: 4, text: "استخدام جيد لعبارات التشجيع وتصحيح الإجابات." }, { val: 3, text: "تعزيز نمطي (أحسنت/ممتاز) دون توضيح السبب." }, { val: 2, text: "قلة التعزيز، أو تجاهل الإجابات الصحيحة." }, { val: 1, text: "استخدام عبارات محبطة أو السخرية من الأخطاء." }], advice: "تقديم تغذية راجعة محددة (أحسنت لأنك قمت بـ...)." , leverage: "بناء ثقة الطلاب بأنفسهم." },
                    { id: "c2", name: "خلق الجو التنافسي", options: [{ val: 5, text: "جو حماسي ممتع وتنافس شريف يحفز الجميع على التعلم." }, { val: 4, text: "وجود روح إيجابية ومسابقات بسيطة." }, { val: 3, text: "جو هادئ ورسمي يخلو من الحماس." }, { val: 2, text: "جو يتسم بالملل والرتابة." }, { val: 1, text: "جو متوتر أو مشحون بالسلبية." }], advice: "إدخال التلعيب (Gamification) في الحصة.", leverage: "إدارة مسابقات منهجية." },
                    { id: "c3", name: "إدارة السلوك التوقعي", options: [{ val: 5, text: "انضباط ذاتي من الطلاب، وعلاقة يسودها الاحترام المتبادل والمودة." }, { val: 4, text: "سيطرة جيدة للمعلم، ومعالجة حكيمة للمشكلات السلوكية." }, { val: 3, text: "انضباط مقبول مع وجود بعض التنبيهات المتكررة." }, { val: 2, text: "ضعف في السيطرة، وكثرة الأحاديث الجانبية." }, { val: 1, text: "فقدان السيطرة تماماً على الصف." }], advice: "وضع ميثاق صفي واضح والاتفاق عليه مع الطلاب.", leverage: "احتواء المشكلات السلوكية بمهارة." }
                ]
            },
            {
                title: "المجال الرابع: التقويم",
                criteria: [
                    { id: "a1", name: "التقويم التكويني (المستمر)", options: [{ val: 5, text: "تقويم مستمر وفعال بعد كل هدف للتأكد من فهم جميع الطلاب." }, { val: 4, text: "استخدام جيد للأسئلة المرحلية أثناء الشرح." }, { val: 3, text: "سؤال عام (هل فهمتم؟) أو سؤال لطالب واحد فقط." }, { val: 2, text: "تقويم نادر أو عشوائي." }, { val: 1, text: "غياب التقويم المرحلي تماماً." }], advice: "استخدام أدوات المسح السريع (مثل الإبهام أو البطاقات).", leverage: "تجويد عمليات القياس والتقويم." },
                    { id: "a2", name: "استخدام النتائج للتعديل", options: [{ val: 5, text: "مرونة عالية في تعديل طريقة التدريس فوراً بناءً على استجابات الطلاب." }, { val: 4, text: "إعادة الشرح للطلاب الذين لم يفهموا." }, { val: 3, text: "الاستمرار في الشرح بنفس الطريقة رغم وجود عدم فهم." }, { val: 2, text: "تجاهل عدم فهم الطلاب واللوم عليهم." }, { val: 1, text: "عدم الاكتراث بمدى فهم الطلاب للمادة." }], advice: "امتلاك خطط بديلة للشرح في حال تعثر الفهم.", leverage: "التدريس التشخيصي العلاجي." },
                    { id: "a4", name: "تنويع أدوات التقويم", options: [{ val: 5, text: "استخدام أدوات متنوعة (شفهي، تحريري، أدائي، ملاحظة) ببراعة." }, { val: 4, text: "الجمع بين الأسئلة الشفهية والكتابية." }, { val: 3, text: "الاعتماد الكلي على الأسئلة الشفهية." }, { val: 2, text: "أدوات تقويم ضعيفة أو غير مناسبة." }, { val: 1, text: "لا توجد أدوات تقويم واضحة." }], advice: "تفعيل سجلات الملاحظة وملفات الإنجاز.", leverage: "تطبيق التقويم الواقعي." },
                    { id: "a5", name: "التقويم الختامي", options: [{ val: 5, text: "غلق متميز يلخص النقاط الرئيسية ويقيس تحقق أهداف الدرس كاملة." }, { val: 4, text: "غلق جيد للدرس مع سؤال ختامي." }, { val: 3, text: "إنهاء الدرس بتلخيص سريع من المعلم." }, { val: 2, text: "غلق مبتور بسبب ضيق الوقت." }, { val: 1, text: "انتهاء الحصة فجأة دون أي غلق." }], advice: "تخصيص الدقائق الخمس الأخيرة للغلق والتقويم النهائي.", leverage: "مهارة التلخيص والربط." }
                ]
            },
            {
                title: "المجال الخامس: النمو المهني",
                criteria: [
                    { id: "pr1", name: "المظهر العام والقدوة الحسنة", options: [{ val: 5, text: "نموذج يحتذى به في المظهر المهني، وسلوك تربوي راقٍ مع الجميع." }, { val: 4, text: "مظهر لائق ومناسب، وسلوك جيد." }, { val: 3, text: "مظهر مقبول." }, { val: 2, text: "ملاحظات بسيطة على المظهر أو السلوك." }, { val: 1, text: "مظهر غير لائق أو سلوكيات تتنافى مع القدوة." }], advice: "الالتزام بالسمت المهني للمعلم.", leverage: "تمثيل القدوة الحسنة." },
                    { id: "pr2", name: "الالتزام المهني", options: [{ val: 5, text: "انضباط تام في المواعيد، وحضور مبكر، وتفانٍ في العمل." }, { val: 4, text: "التزام جيد بالدوام والحصص." }, { val: 3, text: "التزام بالحد الأدنى، مع وجود بعض التأخيرات." }, { val: 2, text: "تكرار التأخر أو الغياب بدون عذر." }, { val: 1, text: "إهمال وظيفي وعدم مبالاة باللوائح." }], advice: "احترام أوقات الدوام والحصص.", leverage: "تعزيز ثقافة الانضباط." },
                    { id: "pr3", name: "اكتمال دفتر التحضير والسجلات", options: [{ val: 5, text: "سجلات كاملة ومنظمة، تحضير متميز، وتوثيق دقيق لكل الأعمال." }, { val: 4, text: "السجلات مكتملة ومحدثة." }, { val: 3, text: "السجلات موجودة لكن ينقصها بعض التنظيم أو التحديث." }, { val: 2, text: "نقص واضح في البيانات أو التحضير." }, { val: 1, text: "عدم وجود تحضير أو سجلات." }], advice: "الاهتمام بالجانب التوثيقي كجزء من المهنية.", leverage: "التوثيق الإداري المتميز." }
                ]
            }
        ];

        const strategiesList = ["العصف الذهني", "العمل الجماعي", "التعلم باللعب", "الحوار والمناقشة", "الاستقصاء", "حل المشكلات", "التعلم المعكوس", "الخرائط الذهنية", "التعلم الذاتي", "القصة التعليمية", "فكر-زاوج-شارك", "أعواد المثلجات", "الكرسي الساخن", "لعب الأدوار", "التدريس التبادلي"];
        const aidsList = ["السبورة المدرسية", "جهاز العرض (Data Show)", "الكتاب المدرسي", "نماذج ومجسمات", "تطبيقات إلكترونية", "بطاقات تعليمية", "سبورة ذكية", "عينات حقيقية", "لوحات توضيحية", "مقاطع فيديو"];
        const activitiesList = ["ورقة عمل فردية", "ورقة عمل جماعية", "نشاط كتابي", "نشاط شفهي", "رسم توضيحي", "تجارب عملية", "عرض تقديمي للطالب", "بحث سريع", "مسابقة حركية", "لعبة تعليمية"];
        
        let selectedStrategies = [];
        let selectedAids = [];
        let selectedActivities = [];
        const colors = ["#f87171", "#fb923c", "#fbbf24", "#a3e635", "#34d399", "#22d3ee", "#818cf8", "#c084fc", "#e879f9", "#f43f5e"];

        function initSelectors() {
            populateSelect('strategiesSelect', strategiesList);
            populateSelect('aidsSelect', aidsList);
            populateSelect('activitiesSelect', activitiesList);
        }

        function populateSelect(id, list) {
            const select = document.getElementById(id);
            list.forEach(item => {
                let opt = document.createElement('option');
                opt.value = item;
                opt.innerText = item;
                select.appendChild(opt);
            });
        }

        function addToWheel(type) {
            const select = document.getElementById(`${type}Select`);
            const val = select.value;
            if (!val) return;

            let list;
            if (type === 'strategies') list = selectedStrategies;
            else if (type === 'aids') list = selectedAids;
            else list = selectedActivities;

            if (list.includes(val)) { select.value = ""; return; }

            list.push(val);
            select.value = ""; 
            renderWheel(type);
            autoSave();
        }

        function removeFromWheel(type, index) {
            let list;
            if (type === 'strategies') list = selectedStrategies;
            else if (type === 'aids') list = selectedAids;
            else list = selectedActivities;
            list.splice(index, 1);
            renderWheel(type);
            autoSave();
        }

        function renderWheel(type) {
            let list;
            if (type === 'strategies') list = selectedStrategies;
            else if (type === 'aids') list = selectedAids;
            else list = selectedActivities;

            const wheelSvg = document.getElementById(`${type}Wheel`);
            const legendDiv = document.getElementById(`${type}Legend`);
            wheelSvg.innerHTML = '';
            legendDiv.innerHTML = '';

            if (list.length === 0) {
                wheelSvg.innerHTML = '<circle r="16" cx="16" cy="16" fill="#f3f4f6" />';
                legendDiv.innerHTML = '<div class="text-xs text-gray-400 text-center mt-8">لم يتم اختيار عناصر</div>';
                return;
            }

            const total = list.length;
            const sliceDeg = 360 / total;
            let currentAngle = 0;
            const center = 16;
            const radius = 16;

            list.forEach((item, index) => {
                const color = colors[index % colors.length];
                const startRad = (currentAngle * Math.PI) / 180;
                const endRad = ((currentAngle + sliceDeg) * Math.PI) / 180;
                
                const x1 = center + radius * Math.cos(startRad);
                const y1 = center + radius * Math.sin(startRad);
                const x2 = center + radius * Math.cos(endRad);
                const y2 = center + radius * Math.sin(endRad);
                const largeArcFlag = sliceDeg > 180 ? 1 : 0;
                
                let pathD = "";
                if (total === 1) {
                    pathD = `M ${center} 0 A ${radius} ${radius} 0 1 1 ${center} 32 A ${radius} ${radius} 0 1 1 ${center} 0`;
                } else {
                    pathD = `M ${center} ${center} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArcFlag} 1 ${x2} ${y2} Z`;
                }

                const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                path.setAttribute("d", pathD);
                path.setAttribute("fill", color);
                path.setAttribute("stroke", "white");
                path.setAttribute("stroke-width", "0.5");
                wheelSvg.appendChild(path);

                currentAngle += sliceDeg;

                const div = document.createElement('div');
                div.className = "legend-item bg-gray-50 p-1.5 rounded border border-gray-100 flex justify-between items-center";
                div.innerHTML = `<div class="flex items-center"><span class="legend-color shadow-sm" style="background-color: ${color};"></span><span class="mr-2 font-bold text-gray-700 truncate" style="max-width: 90px;">${item}</span></div><button onclick="removeFromWheel('${type}', ${index})" class="text-red-400 hover:text-red-600 px-1"><i class="fa-solid fa-times"></i></button>`;
                legendDiv.appendChild(div);
            });
            const centerHole = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            centerHole.setAttribute("r", "6");
            centerHole.setAttribute("cx", "16");
            centerHole.setAttribute("cy", "16");
            centerHole.setAttribute("fill", "white");
            wheelSvg.appendChild(centerHole);
        }

        let timerInterval;
        let activeSpeaker = null; 
        let timeData = { teacher: 0, student: 0 };

        function toggleTimer(speaker) {
            if (activeSpeaker === speaker) { pauseTimer(); return; }
            activeSpeaker = speaker;
            clearInterval(timerInterval);
            updateButtonStyles();
            timerInterval = setInterval(() => { timeData[speaker]++; updateTimerDisplay(); autoSave(); }, 1000);
        }

        function pauseTimer() {
            activeSpeaker = null;
            clearInterval(timerInterval);
            updateButtonStyles();
            autoSave();
        }

        function updateButtonStyles() {
            const btnT = document.getElementById('btnTeacher');
            const btnS = document.getElementById('btnStudent');
            btnT.className = "px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs font-bold transition";
            btnT.innerHTML = '<i class="fa-solid fa-microphone"></i> تحدث';
            btnS.className = "px-3 py-1 bg-orange-500 hover:bg-orange-600 text-white rounded text-xs font-bold transition";
            btnS.innerHTML = '<i class="fa-solid fa-users"></i> تحدث';
            if (activeSpeaker === 'teacher') { btnT.className = "px-3 py-1 bg-blue-800 text-white rounded text-xs font-bold shadow-inner border border-blue-300"; btnT.innerHTML = '<i class="fa-solid fa-microphone animate-pulse"></i> تسجيل'; }
            if (activeSpeaker === 'student') { btnS.className = "px-3 py-1 bg-orange-700 text-white rounded text-xs font-bold shadow-inner border border-orange-300"; btnS.innerHTML = '<i class="fa-solid fa-users animate-pulse"></i> تسجيل'; }
        }

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        }

        function updateTimerDisplay() {
            document.getElementById('teacherTimerDisplay').innerText = formatTime(timeData.teacher);
            document.getElementById('studentTimerDisplay').innerText = formatTime(timeData.student);
            const total = timeData.teacher + timeData.student;
            let tPercent = 0;
            if (total > 0) tPercent = Math.round((timeData.teacher / total) * 100);
            document.getElementById('teacherPercent').innerText = `${tPercent}% م`;
            document.getElementById('studentPercent').innerText = `${100 - tPercent}% ط`;
            const circle = document.getElementById('interactionCircle');
            circle.setAttribute('stroke-dasharray', `${tPercent}, 100`);
        }

        function autoSave() {
            const data = {
                teacherName: document.getElementById('teacherName').value,
                subjectClass: document.getElementById('subjectClass').value,
                visitType: document.getElementById('visitType').value,
                scores: {},
                wheels: { strategies: selectedStrategies, aids: selectedAids, activities: selectedActivities },
                time: timeData,
                signatures: {
                    'sig-teacher': document.getElementById('sig-teacher').toDataURL(),
                    'sig-supervisor': document.getElementById('sig-supervisor').toDataURL(),
                    'sig-admin': document.getElementById('sig-admin').toDataURL()
                },
                names: {
                    teacher: document.getElementById('sigNameTeacher').value,
                    supervisor: document.getElementById('sigNameSupervisor').value,
                    admin: document.getElementById('sigNameAdmin').value
                }
            };

            domains.forEach(d => {
                d.criteria.forEach(c => {
                    data.scores[c.id] = document.getElementById(`select_${c.id}`).value;
                });
            });

            localStorage.setItem('asbeel_eval_data_v3', JSON.stringify(data));
            
            const ind = document.getElementById('saveIndicator');
            ind.style.opacity = '1';
            setTimeout(() => ind.style.opacity = '0', 2000);
        }

        function loadData() {
            const saved = localStorage.getItem('asbeel_eval_data_v3');
            if (!saved) {
                initSignaturePad('sig-teacher'); initSignaturePad('sig-supervisor'); initSignaturePad('sig-admin');
                return;
            }

            const data = JSON.parse(saved);

            if(data.teacherName) document.getElementById('teacherName').value = data.teacherName;
            if(data.subjectClass) document.getElementById('subjectClass').value = data.subjectClass;
            if(data.visitType) document.getElementById('visitType').value = data.visitType;
            
            if(data.names) {
                document.getElementById('sigNameTeacher').value = data.names.teacher || '';
                document.getElementById('sigNameSupervisor').value = data.names.supervisor || '';
                document.getElementById('sigNameAdmin').value = data.names.admin || '';
            }

            if(data.scores) {
                domains.forEach((d, idx) => {
                    d.criteria.forEach(c => {
                        if(data.scores[c.id]) {
                            const sel = document.getElementById(`select_${c.id}`);
                            sel.value = data.scores[c.id];
                            updateRow(c.id, idx);
                        }
                    });
                });
            }

            if(data.wheels) {
                selectedStrategies = data.wheels.strategies || [];
                selectedAids = data.wheels.aids || [];
                selectedActivities = data.wheels.activities || [];
                renderWheel('strategies');
                renderWheel('aids');
                renderWheel('activities');
            }

            if(data.time) {
                timeData = data.time;
                updateTimerDisplay();
            }

            ['sig-teacher', 'sig-supervisor', 'sig-admin'].forEach(id => {
                const canvas = document.getElementById(id);
                const ctx = canvas.getContext('2d');
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                ctx.scale(ratio, ratio);
                
                initSignaturePad(id);

                if(data.signatures && data.signatures[id]) {
                    const img = new Image();
                    img.onload = function() { ctx.drawImage(img, 0, 0, canvas.width / ratio, canvas.height / ratio); };
                    img.src = data.signatures[id];
                }
            });
        }

        function checkCompletion() {
            let isComplete = true;
            domains.forEach(d => {
                d.criteria.forEach(c => {
                    const val = document.getElementById(`select_${c.id}`).value;
                    if (val === "0" || val === "") isComplete = false;
                });
            });
            return isComplete;
        }

        function renderTable() {
            const container = document.getElementById('evaluationTableContainer');
            let html = '';
            domains.forEach((domain, idx) => {
                html += `
                <div class="bg-white rounded-xl shadow-sm mb-4 overflow-hidden border border-slate-200 print:border-black print:mb-4 print:shadow-none">
                    <div class="bg-slate-100 p-3 border-b border-slate-200 flex justify-between items-center print:bg-gray-300 print:border-black">
                        <h3 class="font-bold text-slate-800 text-base print:text-black domain-title-print">${domain.title}</h3>
                    </div>
                    <table class="w-full text-right text-xs md:text-sm">
                        <thead class="bg-slate-50 text-slate-600 print:bg-white print:text-black">
                            <tr>
                                <th class="p-2 w-1/4 border-l border-slate-200 print:border-black">المعيار</th>
                                <th class="p-2 w-1/2 col-rubric border-l border-slate-200 no-print">الدليل الوصفي (اختر المؤشر)</th>
                                <th class="p-2 w-1/8 text-center border-l border-slate-200 print:border-black">الدرجة</th>
                                <th class="p-2 w-1/8 text-center print:border-black">التقدير</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100 print:divide-black">
                `;
                domain.criteria.forEach(c => {
                    html += `
                        <tr class="hover:bg-slate-50 transition print:hover:bg-transparent">
                            <td class="p-2 font-bold text-slate-700 align-middle print:text-black border-l print:border-black">${c.name}</td>
                            <td class="p-2 col-rubric border-l border-slate-200 no-print">
                                <select id="select_${c.id}" onchange="updateRow('${c.id}', ${idx}); autoSave();" class="rubric-select w-full p-1.5 border border-slate-300 rounded focus:ring-2 focus:ring-yellow-400 outline-none bg-white cursor-pointer text-xs">
                                    <option value="0">اختر الوصف...</option>
                                    ${c.options.map(opt => `<option value="${opt.val}">(${opt.val}) ${opt.text}</option>`).join('')}
                                </select>
                            </td>
                            <td class="p-2 text-center align-middle border-l border-slate-200 print:border-black">
                                <div id="score_${c.id}" class="font-bold text-base text-slate-300 print:text-black">-</div>
                            </td>
                            <td class="p-2 text-center align-middle">
                                <span id="rating_${c.id}" class="px-2 py-0.5 rounded text-xs font-bold text-slate-400 block w-full print:border print:border-black print:text-black print:bg-transparent">--</span>
                            </td>
                        </tr>
                    `;
                });
                html += `
                        <tr class="bg-slate-50 font-bold print:bg-gray-100 border-t print:border-black">
                            <td class="p-2 text-slate-800 print:text-black">مجموع نقاط المجال</td>
                            <td class="p-2 col-rubric no-print"></td>
                            <td class="p-2 text-center text-slate-900 text-base print:text-black border-l print:border-black" id="domainTotal_${idx}">0</td>
                            <td class="p-2 text-center text-slate-800 print:text-black" id="domainRating_${idx}">--</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                `;
            });
            container.innerHTML = html;
        }

        function updateRow(id, domainIdx) {
            const select = document.getElementById(`select_${id}`);
            const scoreDisplay = document.getElementById(`score_${id}`);
            const ratingDisplay = document.getElementById(`rating_${id}`);
            const val = parseInt(select.value);
            if (val > 0) {
                scoreDisplay.innerText = val;
                scoreDisplay.className = "font-bold text-base text-slate-800 print:text-black";
                let text = val === 5 ? "ممتاز" : val === 4 ? "جيد جداً" : val === 3 ? "جيد" : val === 2 ? "مقبول" : "ضعيف";
                let color = val >= 4 ? "bg-emerald-100 text-emerald-800" : val === 3 ? "bg-blue-100 text-blue-800" : "bg-red-100 text-red-800";
                ratingDisplay.innerText = text;
                ratingDisplay.className = `px-2 py-0.5 rounded text-xs font-bold block w-full ${color} print:bg-transparent print:text-black print:border print:border-black`;
            } else {
                scoreDisplay.innerText = "-";
                ratingDisplay.innerText = "--";
                ratingDisplay.className = "px-2 py-0.5 rounded text-xs font-bold text-slate-400 block w-full";
            }
            calculateDomain(domainIdx);
            calculateGrandTotal();
        }

        function calculateDomain(idx) {
            let total = 0;
            const domain = domains[idx];
            domain.criteria.forEach(c => { total += parseInt(document.getElementById(`select_${c.id}`).value) || 0; });
            document.getElementById(`domainTotal_${idx}`).innerText = total;
            const max = domain.criteria.length * 5;
            const percent = total > 0 ? (total / max) * 100 : 0;
            const ratingEl = document.getElementById(`domainRating_${idx}`);
            if (total === 0) ratingEl.innerText = "--";
            else if (percent >= 90) ratingEl.innerText = "متميز";
            else if (percent >= 80) ratingEl.innerText = "جيد جداً";
            else if (percent >= 70) ratingEl.innerText = "جيد";
            else if (percent >= 60) ratingEl.innerText = "مقبول";
            else ratingEl.innerText = "ضعيف";
        }

        function calculateGrandTotal() {
            let total = 0;
            let maxTotal = 0;
            domains.forEach(d => { d.criteria.forEach(c => { total += parseInt(document.getElementById(`select_${c.id}`).value) || 0; maxTotal += 5; }); });
            document.getElementById('grandTotalPoints').innerText = total;
            document.getElementById('grandTotalPoints').nextElementSibling.innerText = "/ " + maxTotal; 
            const percent = maxTotal > 0 ? Math.round((total / maxTotal) * 100) : 0;
            document.getElementById('grandTotalPercent').innerText = percent + "%";
            const ratingEl = document.getElementById('grandTotalRating');
            if (percent >= 90) { ratingEl.innerText = "متميز"; ratingEl.className = "px-4 py-1 rounded-lg bg-emerald-600 font-bold text-white print:bg-white print:text-black print:border print:border-black"; }
            else if (percent >= 80) { ratingEl.innerText = "جيد جداً"; ratingEl.className = "px-4 py-1 rounded-lg bg-blue-600 font-bold text-white print:bg-white print:text-black print:border print:border-black"; }
            else if (percent >= 70) { ratingEl.innerText = "جيد"; ratingEl.className = "px-4 py-1 rounded-lg bg-indigo-500 font-bold text-white print:bg-white print:text-black print:border print:border-black"; }
            else if (percent >= 60) { ratingEl.innerText = "مقبول"; ratingEl.className = "px-4 py-1 rounded-lg bg-orange-500 font-bold text-white print:bg-white print:text-black print:border print:border-black"; }
            else { ratingEl.innerText = "ضعيف"; ratingEl.className = "px-4 py-1 rounded-lg bg-red-600 font-bold text-white print:bg-white print:text-black print:border print:border-black"; }
        }

        function toggleReport(reportId, generateFn) {
            const reportEl = document.getElementById(reportId);
            const parentSection = document.getElementById('reportsSection');
            const isHidden = reportEl.classList.contains('hidden') || reportEl.classList.contains('print:hidden');
            
            if (isHidden) {
                if (!checkCompletion()) { alert("عذراً، لا يمكن توليد التقرير قبل استكمال تقييم جميع المعايير."); return; }
                generateFn();
                parentSection.classList.remove('hidden');
                reportEl.classList.remove('hidden');
                reportEl.classList.remove('print:hidden');
                reportEl.scrollIntoView({behavior: 'smooth'});
            } else {
                reportEl.classList.add('hidden');
                reportEl.classList.add('print:hidden');
            }
        }

        function generateStatisticalReport() {
            const table = document.getElementById('statsTable');
            const totalScore = document.getElementById('grandTotalPoints').innerText;
            const totalPercent = document.getElementById('grandTotalPercent').innerText;
            const totalRating = document.getElementById('grandTotalRating').innerText;
            const totalTime = timeData.teacher + timeData.student;
            let tPercent = 0;
            if (totalTime > 0) tPercent = Math.round((timeData.teacher / totalTime) * 100);
            
            let domainsHTML = '<ul class="list-none p-0 m-0 space-y-1 text-xs">';
            domains.forEach((d, idx) => {
                const score = document.getElementById(`domainTotal_${idx}`).innerText;
                const max = d.criteria.length * 5;
                const rating = document.getElementById(`domainRating_${idx}`).innerText;
                domainsHTML += `<li class="flex justify-between border-b border-gray-100 pb-1 last:border-0"><span>${d.title.split(':')[1] || d.title}</span><span class="font-bold">${score}/${max} (${rating})</span></li>`;
            });
            domainsHTML += '</ul>';

            const strats = selectedStrategies.length > 0 ? selectedStrategies.join('<br>') : "لا يوجد";
            const aids = selectedAids.length > 0 ? selectedAids.join('<br>') : "لا يوجد";
            const acts = selectedActivities.length > 0 ? selectedActivities.join('<br>') : "لا يوجد";

            let html = `
                <thead class="bg-purple-100 text-purple-900 print:bg-gray-200 print:text-black">
                    <tr><th class="p-2 border border-purple-200 print:border-black">الأداء العام</th><th class="p-2 border border-purple-200 print:border-black w-1/4">تحليل المجالات</th><th class="p-2 border border-purple-200 print:border-black">الاستراتيجيات</th><th class="p-2 border border-purple-200 print:border-black">الوسائل</th><th class="p-2 border border-purple-200 print:border-black">الأنشطة</th><th class="p-2 border border-purple-200 print:border-black">التفاعل اللفظي</th></tr>
                </thead>
                <tbody>
                    <tr class="align-top bg-white">
                        <td class="p-3 border border-purple-100 print:border-black text-center"><div class="text-2xl font-bold mb-1">${totalScore} / 100</div><div class="text-sm font-bold text-purple-700 mb-1">${totalPercent}</div><div class="inline-block px-2 py-1 bg-purple-50 rounded text-xs border border-purple-200 font-bold">${totalRating}</div></td>
                        <td class="p-3 border border-purple-100 print:border-black">${domainsHTML}</td>
                        <td class="p-3 border border-purple-100 print:border-black text-xs leading-relaxed">${strats}</td>
                        <td class="p-3 border border-purple-100 print:border-black text-xs leading-relaxed">${aids}</td>
                        <td class="p-3 border border-purple-100 print:border-black text-xs leading-relaxed">${acts}</td>
                        <td class="p-3 border border-purple-100 print:border-black text-center text-xs"><div class="mb-2 font-bold">المعلم: ${tPercent}%</div><div class="mb-2 font-bold">الطالب: ${100 - tPercent}%</div><div class="text-gray-500 text-[10px]">الزمن الكلي: ${formatTime(totalTime)}</div></td>
                    </tr>
                </tbody>
            `;
            table.innerHTML = html;
        }

        function generateAIReport() {
            const content = document.getElementById('aiReportContent');
            let weaknesses = [];
            let strengths = [];
            domains.forEach(d => { d.criteria.forEach(c => { const val = parseInt(document.getElementById(`select_${c.id}`).value) || 0; if (val > 0 && val <= 3) weaknesses.push({ name: c.name, val: val, advice: c.advice }); if (val >= 4) strengths.push({ name: c.name, leverage: c.leverage }); }); });
            let html = ``;
            if (strengths.length > 0) { html += `<div class="mb-4"><h4 class="font-bold text-emerald-800 mb-2 border-b border-emerald-200 pb-1">نقاط القوة وفرص الاستثمار:</h4><ul class="list-disc list-inside space-y-1">`; strengths.forEach(s => { html += `<li>يتميز المعلم في <strong>${s.name}</strong>، ويمكن استثمار ذلك من خلال: ${s.leverage}</li>`; }); html += `</ul></div>`; }
            if (weaknesses.length > 0) { html += `<div><h4 class="font-bold text-red-800 mb-2 border-b border-red-200 pb-1">نقاط تحتاج لتحسين (التشخيص والتوجيه):</h4><ul class="list-disc list-inside space-y-1">`; weaknesses.forEach(w => { html += `<li><strong>${w.name}</strong> (المستوى: ${w.val}/5): يوصى بـ ${w.advice}</li>`; }); html += `</ul></div>`; } else if (strengths.length > 0) { html += `<p class="text-emerald-700 font-bold text-center">أداء المعلم متميز ولا توجد نقاط ضعف حرجة.</p>`; }
            content.innerHTML = html;
        }

        function generateRemedialPlan() {
            const content = document.getElementById('remedialPlanContent');
            let lowCriteria = [];
            domains.forEach(d => d.criteria.forEach(c => { const val = parseInt(document.getElementById(`select_${c.id}`).value) || 0; if (val > 0 && val <= 3) lowCriteria.push(c.name); }));
            if (lowCriteria.length === 0) { content.innerHTML = `<div class="text-center p-4 bg-emerald-50 text-emerald-800 rounded"><strong>خطة إثرائية:</strong> نظراً لتميز المعلم، يوصى بتكليفه بمهام قيادية.</div>`; return; }
            let html = `<div class="mb-4"><p class="text-sm font-bold text-slate-700 mb-2">بناءً على النتائج، يوصى باتباع المسار التالي:</p></div><table class="w-full text-right border border-gray-300 text-sm print:border-black"><thead class="bg-gray-100 print:bg-gray-300"><tr><th class="p-2 border">الإجراء المقترح</th><th class="p-2 border">الهدف</th><th class="p-2 border">جهة التنفيذ</th><th class="p-2 border">الفترة</th></tr></thead><tbody><tr><td class="p-2 border">زيارات تبادلية</td><td class="p-2 border">معالجة القصور في: (${lowCriteria.slice(0, 3).join('، ')}).</td><td class="p-2 border">المدير</td><td class="p-2 border">أسبوعان</td></tr><tr><td class="p-2 border">تطبيقات عملية</td><td class="p-2 border">التدريب على الاستراتيجيات.</td><td class="p-2 border">الموجه</td><td class="p-2 border">شهر</td></tr></tbody></table>`;
            content.innerHTML = html;
        }

        function resetData() {
            if(!confirm("هل أنت متأكد من تصفير جميع البيانات؟")) return;
            localStorage.removeItem('asbeel_eval_data_v3');
            location.reload(); 
        }

        function checkAndPrint() {
            if (!checkCompletion()) { alert("لا يمكن الطباعة قبل استكمال تقييم جميع المعايير."); return; }
            document.getElementById('visitTypePrint').innerText = document.getElementById('visitType').value;
            window.print();
        }

        function shareReport() {
            if (!checkCompletion()) { alert("لا يمكن المشاركة قبل استكمال التقييم."); return; }
            const name = document.getElementById('teacherName').value || "المعلم";
            const score = document.getElementById('grandTotalPercent').innerText;
            const text = `تم تقييم المعلم: ${name}\nالنتيجة النهائية: ${score}\nنموذج تقييم مدارس اسبيل الأهلية.`;
            if (navigator.share) { navigator.share({ title: 'تقرير تقييم معلم', text: text, url: window.location.href }); } else { alert("تم نسخ ملخص التقرير للحافظة:\n" + text); }
        }

        function initSignaturePad(canvasId) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            let isDrawing = false;
            function resizeCanvas() {
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                ctx.scale(ratio, ratio);
                
                const data = localStorage.getItem('asbeel_eval_data_v3');
                if(data) {
                    const parsed = JSON.parse(data);
                    if(parsed.signatures && parsed.signatures[canvasId]) {
                        const img = new Image();
                        img.onload = () => ctx.drawImage(img, 0, 0, canvas.width / ratio, canvas.height / ratio);
                        img.src = parsed.signatures[canvasId];
                    }
                }
            }
            window.addEventListener("resize", resizeCanvas);
            
            function getPos(e) {
                const rect = canvas.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return { x: clientX - rect.left, y: clientY - rect.top };
            }
            function startDraw(e) {
                isDrawing = true;
                const pos = getPos(e);
                ctx.beginPath();
                ctx.moveTo(pos.x, pos.y);
                e.preventDefault();
            }
            function draw(e) {
                if (!isDrawing) return;
                const pos = getPos(e);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
                e.preventDefault();
            }
            function endDraw() { if(isDrawing) { isDrawing = false; autoSave(); } }
            canvas.addEventListener('mousedown', startDraw);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', endDraw);
            canvas.addEventListener('mouseout', endDraw);
            canvas.addEventListener('touchstart', startDraw, {passive: false});
            canvas.addEventListener('touchmove', draw, {passive: false});
            canvas.addEventListener('touchend', endDraw);
        }

        function clearSig(id) {
            const canvas = document.getElementById(id);
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            autoSave();
        }

        initSelectors();
        renderTable();
        window.addEventListener('load', loadData);
    </script>
</body>
                        </html>
